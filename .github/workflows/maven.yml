name: CI

on:
  push:
    paths:
      - "**.java"
      - "pom.xml"
      - ".github/**"
  pull_request:
    paths:
      - "*"

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v2

      - name: Cache maven build
        uses: actions/cache@v1
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build with Maven
        uses: xlui/action-maven-cli/jdk8@master
        with:
          args: -B clean javadoc:jar test jacoco:report sonar:sonar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Show Error Logs
        if: failure()
        run: |
          cat hs_err_pid* 2> /dev/null || true
          rm hs_err_pid* 2> /dev/null || true

  deploy:
    name: Deploy
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'

    steps:
      - name: Generate build number
        uses: einaregilsson/build-number@v2
        with:
          token: ${{secrets.github_token}}

      - name: Print build number
        run: echo "Build number is $BUILD_NUMBER"

      - name: Checkout repo
        uses: actions/checkout@v2

      - name: Cache maven build
        uses: actions/cache@v1
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Apply build number
        run: |
          sed -i "s|<version>dev_build</version>|<version>build_$BUILD_NUMBER</version>|g" pom.xml

      - name: Configure Maven Deploy
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USERNAME: thedudefromci
        run: |
          mkdir -p ~/.m2
          echo "<settings><servers><server><id>github</id><username>${USERNAME}</username><password>${GITHUB_TOKEN}</password></server></servers></settings>" > ~/.m2/settings.xml
          mvn -B clean package deploy

      - name: Create Release Version
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: github.GITHUB_REF
          release_name: Build ${BUILD_NUMBER}
          draft: false
          prerelease: true
          body: |
            Auto-generated Build ${BUILD_NUMBER}.

      - name: Create Zip Release
        run: |
          cp target/wraithengine-*.jar dist
          zip build *

      - name: Upload Release Zip
        id: upload-release-asset
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./dist/build.zip
          asset_name: build_${BUILD_NUMBER}.zip
          asset_content_type: application/zip
